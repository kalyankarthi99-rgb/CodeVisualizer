<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Longest Palindrome - Interactive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
        }

        .font-mono { font-family: 'Fira Code', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Grid Animations */
        .cell { transition: all 0.2s ease; }
        .cell-true { background-color: #10b981; color: white; border-color: #059669; } /* Emerald */
        .cell-false { background-color: #ef4444; color: white; border-color: #b91c1c; } /* Red */
        .cell-check { background-color: #f59e0b; color: white; transform: scale(1.1); z-index: 10; box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); } /* Amber */
        
        .char-box { transition: all 0.2s; }
        .char-active { background-color: #f59e0b; color: white; border-color: #d97706; transform: translateY(-2px); }
        .char-match { background-color: #10b981; color: white; border-color: #059669; }

        .code-active { background-color: #312e81; border-left: 2px solid #818cf8; opacity: 1; font-weight: 500; color: #e0e7ff; }
        
        /* Resizers */
        .resizer-v { width: 4px; cursor: col-resize; background: #1e293b; transition: background 0.2s; z-index: 50; }
        .resizer-v:hover, .resizer-v.dragging { background: #6366f1; }
        .resizer-h { height: 4px; cursor: row-resize; background: #1e293b; transition: background 0.2s; z-index: 50; }
        .resizer-h:hover, .resizer-h.dragging { background: #6366f1; }

        .panel-btn { @apply p-1.5 text-slate-400 hover:text-white hover:bg-slate-700 rounded transition-colors; }
        .drag-overlay { position: fixed; inset: 0; z-index: 9999; cursor: inherit; display: none; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Navbar -->
    <header class="bg-slate-900 border-b border-slate-800 h-14 shrink-0 flex items-center justify-between px-4 z-50">
        <div class="flex items-center gap-3">
            <a href="index.html" class="p-1.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-all">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="font-bold text-white text-sm md:text-base flex items-center gap-2">
                <i class="fas fa-code-branch text-emerald-500"></i>
                Longest Palindromic Substring
            </h1>
        </div>
        <button onclick="layoutReset()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded border border-slate-700 transition-colors">
            <i class="fas fa-columns mr-1"></i> Reset Layout
        </button>
    </header>

    <!-- Main Layout -->
    <div id="layout-container" class="flex flex-col md:flex-row flex-1 overflow-hidden relative">
        <div class="drag-overlay" id="dragOverlay"></div>

        <!-- Sidebar -->
        <aside id="panel-sidebar" class="bg-slate-900 flex flex-col border-b md:border-b-0 md:border-r border-slate-800 min-w-[250px] md:w-80 shrink-0 relative" style="height: auto;">
            
            <div class="h-10 bg-slate-950/50 border-b border-slate-800 flex items-center justify-between px-3 shrink-0">
                <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Configuration</span>
                <button class="panel-btn md:hidden" onclick="togglePanel('sidebar-content')"><i class="fas fa-chevron-up"></i></button>
            </div>

            <div id="sidebar-content" class="flex-1 overflow-y-auto p-4 space-y-6">
                <!-- Input -->
                <div class="space-y-3">
                    <div class="flex flex-col gap-2">
                        <label class="text-xs font-medium text-slate-300">Input String</label>
                        <div class="flex gap-2">
                            <input type="text" id="inputString" value="babad" maxlength="12" 
                                class="w-full bg-slate-800 border border-slate-700 text-white px-3 py-2 rounded-md font-mono text-sm tracking-widest focus:border-emerald-500" placeholder="Max 12 chars">
                            <button id="btnReset" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-md text-sm font-medium">Set</button>
                        </div>
                        <div class="relative">
                            <select id="algoSelect" class="w-full bg-slate-800 border border-slate-700 text-white px-3 py-2 rounded-md text-sm focus:border-emerald-500 cursor-pointer">
                                <option value="DP">Solution 1: Dynamic Programming (O(N²))</option>
                                <option value="EXPAND">Solution 2: Expand Around Center (O(N²))</option>
                                <option value="BRUTE">Solution 3: Brute Force (O(N³))</option>
                            </select>
                            <div class="absolute right-3 top-2.5 text-slate-400 pointer-events-none text-xs"><i class="fas fa-chevron-down"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Playback -->
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase text-slate-400 tracking-wider">Controls</span>
                        <span id="speedLabel" class="text-xs text-slate-400 font-mono">1.0x</span>
                    </div>
                    <div class="flex items-center gap-2 justify-center">
                        <button id="btnPrev" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center text-white disabled:opacity-50"><i class="fas fa-step-backward text-xs"></i></button>
                        <button id="btnPlay" class="w-10 h-10 rounded-full bg-emerald-500 hover:bg-emerald-600 flex items-center justify-center text-white shadow-lg hover:scale-105 transition-all"><i class="fas fa-play pl-1 text-sm"></i></button>
                        <button id="btnNext" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center text-white disabled:opacity-50"><i class="fas fa-step-forward text-xs"></i></button>
                    </div>
                    <input type="range" id="speedRange" min="1" max="50" value="10" class="w-full h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                </div>

                <!-- Stats -->
                <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                    <div class="text-xs text-slate-400 mb-1">Current Max</div>
                    <div class="flex justify-between items-end">
                        <div id="currentLongestDisplay" class="text-lg font-mono font-bold text-emerald-400 truncate w-32">-</div>
                        <div class="text-xs text-slate-500">Len: <span id="currentLength" class="text-slate-300">0</span></div>
                    </div>
                </div>
            </div>
        </aside>

        <div id="resizer-v" class="resizer-v hidden md:block" onmousedown="initDrag(event, 'h')"></div>

        <!-- Right Panel -->
        <div class="flex-1 flex flex-col min-w-0 h-full overflow-hidden">
            
            <!-- Visualizer -->
            <div id="panel-viz" class="flex-1 flex flex-col bg-slate-950 relative min-h-[200px] transition-all">
                <div class="h-10 bg-slate-900/80 border-b border-slate-800 flex items-center justify-between px-3 shrink-0 backdrop-blur-sm z-20">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Visualizer</span>
                    </div>
                    <button class="panel-btn" onclick="toggleMaximize('panel-viz')"><i class="fas fa-expand text-xs"></i></button>
                </div>

                <div class="flex-1 overflow-auto flex flex-col items-center justify-center p-8 bg-slate-950 relative" id="vizContainer">
                    
                    <!-- String Container -->
                    <div class="flex justify-center mb-8 gap-2 relative z-10" id="stringContainer"></div>

                    <!-- DP Grid (Only for DP Algo) -->
                    <div id="gridWrapper" class="inline-block bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-2xl relative transition-opacity duration-300">
                        <div class="absolute -left-8 top-12 bottom-0 flex flex-col justify-around text-slate-500 font-mono text-xs w-6 py-2" id="rowIndices"></div>
                        <div class="absolute -top-8 left-12 right-0 flex justify-around text-slate-500 font-mono text-xs h-6 px-2" id="colIndices"></div>
                        <div id="gridContainer" class="grid gap-1"></div>
                    </div>

                    <!-- Instruction Overlay -->
                    <div class="absolute bottom-4 left-0 right-0 text-center pointer-events-none">
                        <span id="instructionText" class="bg-slate-900/90 text-slate-200 px-4 py-2 rounded-full text-sm font-medium border border-slate-700 shadow-xl backdrop-blur-sm">
                            Select an algorithm to start.
                        </span>
                    </div>
                </div>
            </div>

            <div id="resizer-h" class="resizer-h hidden md:block" onmousedown="initDrag(event, 'v')"></div>

            <!-- Code & Details -->
            <div id="panel-code" class="h-1/3 min-h-[40px] bg-slate-900 flex flex-col border-t border-slate-800 relative transition-all">
                <div class="h-10 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-3 shrink-0">
                    <div class="flex gap-4">
                        <button id="tab-code" class="text-xs font-semibold text-white border-b-2 border-emerald-500 h-10 px-1 transition-colors" onclick="switchTab('code')">Code Trace</button>
                        <button id="tab-desc" class="text-xs font-semibold text-slate-400 hover:text-white border-b-2 border-transparent h-10 px-1 transition-colors" onclick="switchTab('desc')">Description</button>
                        <button id="tab-sol" class="text-xs font-semibold text-slate-400 hover:text-white border-b-2 border-transparent h-10 px-1 transition-colors" onclick="switchTab('sol')">Solution</button>
                    </div>
                    <div class="flex gap-1">
                        <button class="panel-btn" onclick="toggleMaximize('panel-code')"><i class="fas fa-expand text-xs"></i></button>
                        <button class="panel-btn" onclick="toggleMinimize('panel-code')"><i class="fas fa-minus text-xs"></i></button>
                    </div>
                </div>

                <div class="flex-1 overflow-hidden relative">
                    <!-- Tab: Code -->
                    <div id="content-code" class="absolute inset-0 flex flex-col md:flex-row">
                        <div class="w-full md:w-1/2 overflow-auto p-4 bg-slate-950 border-r border-slate-800">
                            <pre class="font-mono text-xs text-slate-400 leading-relaxed whitespace-pre" id="codeDisplay"></pre>
                        </div>
                        <div class="w-full md:w-1/2 p-4 bg-slate-900 overflow-y-auto">
                            <h4 class="text-emerald-400 font-bold text-xs uppercase tracking-wider mb-2">Step Explanation</h4>
                            <div id="stepExplanation" class="text-slate-300 text-sm leading-relaxed"></div>
                        </div>
                    </div>

                    <!-- Tab: Description -->
                    <div id="content-desc" class="absolute inset-0 overflow-auto p-6 hidden bg-slate-900 text-slate-300 text-sm">
                        <h2 class="text-lg font-bold text-white mb-2" id="desc-title">Problem Description</h2>
                        <div id="desc-text" class="leading-relaxed"></div>
                    </div>

                    <!-- Tab: Solution -->
                    <div id="content-sol" class="absolute inset-0 overflow-auto p-6 hidden bg-slate-900 text-slate-300 text-sm">
                        <h2 class="text-lg font-bold text-white mb-2" id="sol-title">Approach</h2>
                        <div id="sol-strategy" class="leading-relaxed mb-4"></div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div class="text-xs font-bold text-slate-500">Time</div>
                                <div id="sol-time" class="text-emerald-400 font-mono"></div>
                            </div>
                            <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div class="text-xs font-bold text-slate-500">Space</div>
                                <div id="sol-space" class="text-emerald-400 font-mono"></div>
                            </div>
                        </div>
                        <div class="bg-slate-950 p-3 rounded border border-slate-800">
                            <div class="text-xs font-bold text-slate-500 mb-1">Intuition</div>
                            <p id="sol-intuition" class="italic text-slate-400"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
/** Layout Engine (Same as StringPer) */
let isDragging = false;
let currentResizer = null;
const elsLayout = {
    container: document.getElementById('layout-container'),
    sidebar: document.getElementById('panel-sidebar'),
    vizPanel: document.getElementById('panel-viz'),
    codePanel: document.getElementById('panel-code'),
    dragOverlay: document.getElementById('dragOverlay')
};

function initDrag(e, dir) {
    if(window.innerWidth < 768) return;
    isDragging = true; currentResizer = dir;
    elsLayout.dragOverlay.style.display = 'block';
    document.body.style.cursor = dir === 'h' ? 'col-resize' : 'row-resize';
}

document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    if (currentResizer === 'h') {
        const newWidth = Math.max(200, Math.min(e.clientX, window.innerWidth * 0.5));
        elsLayout.sidebar.style.width = `${newWidth}px`;
        elsLayout.sidebar.style.flex = 'none';
    } else {
        const rect = elsLayout.container.getBoundingClientRect();
        const newCodeHeight = rect.height - (e.clientY - rect.top);
        const h = Math.max(40, Math.min(newCodeHeight, rect.height * 0.8));
        elsLayout.codePanel.style.height = `${h}px`;
    }
});

document.addEventListener('mouseup', () => {
    if(isDragging) { isDragging = false; elsLayout.dragOverlay.style.display = 'none'; document.body.style.cursor = ''; }
});

function toggleMaximize(id) {
    const p = document.getElementById(id);
    if(id === 'panel-viz') {
        elsLayout.codePanel.style.height = elsLayout.codePanel.style.height === '40px' ? '33%' : '40px';
    } else {
        elsLayout.codePanel.style.height = elsLayout.codePanel.style.height === '80%' ? '33%' : '80%';
    }
}
function toggleMinimize(id) { document.getElementById(id).style.height = '40px'; }
function layoutReset() {
    if(window.innerWidth >= 768) { elsLayout.sidebar.style.width = '20rem'; elsLayout.codePanel.style.height = '33%'; }
}
function togglePanel(id) {
    const el = document.getElementById(id);
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

/** Logic */
const state = { str: '', steps: [], currentStepIndex: -1, isPlaying: false, speed: 500, timer: null, algo: 'DP' };

const els = {
    input: document.getElementById('inputString'),
    algoSelect: document.getElementById('algoSelect'),
    btnReset: document.getElementById('btnReset'),
    btnPrev: document.getElementById('btnPrev'), btnPlay: document.getElementById('btnPlay'), btnNext: document.getElementById('btnNext'),
    speedRange: document.getElementById('speedRange'), speedLabel: document.getElementById('speedLabel'),
    gridWrapper: document.getElementById('gridWrapper'), grid: document.getElementById('gridContainer'),
    strContainer: document.getElementById('stringContainer'),
    instruction: document.getElementById('instructionText'),
    rowIndices: document.getElementById('rowIndices'), colIndices: document.getElementById('colIndices'),
    longestDisplay: document.getElementById('currentLongestDisplay'), lengthDisplay: document.getElementById('currentLength'),
    codeDisplay: document.getElementById('codeDisplay'), stepExplanation: document.getElementById('stepExplanation'),
    descTitle: document.getElementById('desc-title'), descText: document.getElementById('desc-text'),
    solTitle: document.getElementById('sol-title'), solStrategy: document.getElementById('sol-strategy'), solTime: document.getElementById('sol-time'), solSpace: document.getElementById('sol-space'), solIntuition: document.getElementById('sol-intuition')
};

const ALGOS = {
    BRUTE: {
        name: "Brute Force",
        desc: "Checks every possible substring to see if it's a palindrome.",
        strategy: "Iterate through all possible start (i) and end (j) indices. For each substring s[i...j], check if it reads the same forwards and backwards. Keep track of the maximum length found.",
        time: "O(N³)", space: "O(1)",
        intuition: "Simple but slow. Good for understanding the problem definition.",
        code: [
            { text: "for i from 0 to n:", indent: 0 },
            { text: "for j from i to n:", indent: 1 },
            { text: "if isPalindrome(s[i...j]):", indent: 2 },
            { text: "updateMax(s[i...j])", indent: 3 }
        ]
    },
    DP: {
        name: "Dynamic Programming",
        desc: "Builds a table where dp[i][j] is true if s[i...j] is a palindrome.",
        strategy: "Use a 2D boolean table. Fill base cases (length 1 and 2). For length 3+, s[i...j] is a palindrome if s[i]==s[j] AND s[i+1...j-1] is a palindrome. This reuses previous computations.",
        time: "O(N²)", space: "O(N²)",
        intuition: "A palindrome is a character, followed by a smaller palindrome, followed by the same character.",
        code: [
            { text: "for len from 1 to n:", indent: 0 },
            { text: "for i from 0 to n-len:", indent: 1 },
            { text: "j = i + len - 1", indent: 2 },
            { text: "if s[i] == s[j] and dp[i+1][j-1]:", indent: 2 },
            { text: "dp[i][j] = true", indent: 3 }
        ]
    },
    EXPAND: {
        name: "Expand Around Center",
        desc: "Expands outwards from every possible center.",
        strategy: "A palindrome mirrors around its center. There are 2N-1 centers (N chars + N-1 spaces between). For each center, expand left and right while characters match.",
        time: "O(N²)", space: "O(1)",
        intuition: "Avoids storing a huge table. Just verifies palindromes by growing them.",
        code: [
            { text: "for i from 0 to n:", indent: 0 },
            { text: "expand(i, i)   // Odd len", indent: 1 },
            { text: "expand(i, i+1) // Even len", indent: 1 }
        ]
    }
};

const STEP_TYPE = { INIT: 'INIT', COMPARE: 'COMPARE', MATCH: 'MATCH', MISMATCH: 'MISMATCH', UPDATE_MAX: 'UPDATE_MAX', FINISH: 'FINISH' };

init();

function init() {
    setupEventListeners();
    resetVisualization(els.input.value);
    layoutReset();
}

function switchTab(t) {
    ['code','desc','sol'].forEach(x => {
        document.getElementById(`tab-${x}`).classList.toggle('text-white', x===t);
        document.getElementById(`tab-${x}`).classList.toggle('border-emerald-500', x===t);
        document.getElementById(`tab-${x}`).classList.toggle('text-slate-400', x!==t);
        document.getElementById(`tab-${x}`).classList.toggle('border-transparent', x!==t);
        document.getElementById(`content-${x}`).style.display = x===t ? 'flex' : 'none';
        if(x==='desc' || x==='sol') document.getElementById(`content-${x}`).style.display = 'block';
    });
}

function setupEventListeners() {
    els.btnReset.addEventListener('click', () => resetVisualization(els.input.value));
    els.algoSelect.addEventListener('change', () => resetVisualization(els.input.value));
    els.input.addEventListener('keypress', (e) => { if(e.key==='Enter') resetVisualization(els.input.value); });
    els.btnNext.addEventListener('click', () => { stopPlayback(); nextStep(); });
    els.btnPrev.addEventListener('click', () => { stopPlayback(); prevStep(); });
    els.btnPlay.addEventListener('click', togglePlayback);
    els.speedRange.addEventListener('input', (e) => {
        state.speed = Math.max(50, 1500 - (e.target.value * 28));
        els.speedLabel.textContent = `${(1000/state.speed).toFixed(1)}x`;
        if(state.isPlaying) { stopPlayback(); startPlayback(); }
    });
}

function resetVisualization(str) {
    stopPlayback();
    state.str = str.replace(/[^a-zA-Z0-9]/g, '').slice(0, 12).toUpperCase() || "BABAD";
    els.input.value = state.str;
    state.algo = els.algoSelect.value;
    
    // UI Setup
    renderInfo();
    buildStringUI(state.str);
    
    // Grid Visibility
    if (state.algo === 'DP') {
        els.gridWrapper.style.display = 'inline-block';
        buildGridUI(state.str.length);
    } else {
        els.gridWrapper.style.display = 'none';
    }

    // Logic
    if (state.algo === 'BRUTE') state.steps = generateBrute(state.str);
    else if (state.algo === 'EXPAND') state.steps = generateExpand(state.str);
    else state.steps = generateDP(state.str);
    
    state.currentStepIndex = -1;
    els.longestDisplay.textContent = '-';
    els.lengthDisplay.textContent = '0';
    els.instruction.textContent = 'Ready.';
    highlightCode(-1);
    updateControls();
}

function renderInfo() {
    const data = ALGOS[state.algo];
    els.codeDisplay.innerHTML = data.code.map((l,i) => `<div id="code-line-${i}" class="code-line">${'&nbsp;'.repeat(l.indent*2)}${l.text}</div>`).join('');
    els.descTitle.textContent = data.name; els.descText.textContent = data.desc;
    els.solTitle.textContent = data.name; els.solStrategy.textContent = data.strategy;
    els.solTime.textContent = data.time; els.solSpace.textContent = data.space; els.solIntuition.textContent = data.intuition;
}

// --- Generators ---

function generateBrute(s) {
    const steps = []; const n = s.length;
    steps.push({ type: STEP_TYPE.INIT, line: 0, msg: "Start Brute Force" });
    for(let i=0; i<n; i++) {
        for(let j=i; j<n; j++) {
            steps.push({ type: STEP_TYPE.COMPARE, line: 2, i, j, msg: `Checking substring s[${i}...${j}]` });
            let isPal = true;
            for(let k=0; k<(j-i+1)/2; k++) {
                if(s[i+k] !== s[j-k]) { isPal = false; break; }
            }
            if(isPal) {
                steps.push({ type: STEP_TYPE.MATCH, line: 3, i, j, msg: `It is a Palindrome!` });
                steps.push({ type: STEP_TYPE.UPDATE_MAX, line: 3, start: i, len: j-i+1, msg: `Updating Max Length` });
            }
        }
    }
    return steps;
}

function generateExpand(s) {
    const steps = []; const n = s.length;
    steps.push({ type: STEP_TYPE.INIT, line: 0, msg: "Start Expand Around Center" });
    for(let i=0; i<n; i++) {
        // Odd
        expand(i, i);
        // Even
        if(i+1 < n) expand(i, i+1);
    }
    function expand(L, R) {
        steps.push({ type: STEP_TYPE.COMPARE, line: 1, i: L, j: R, msg: `New Center: ${L===R ? `Index ${L}` : `Indices ${L},${R}`}` });
        while(L >= 0 && R < n && s[L] === s[R]) {
            steps.push({ type: STEP_TYPE.MATCH, line: 1, i: L, j: R, msg: `Match '${s[L]}' == '${s[R]}'. Expanding...` });
            steps.push({ type: STEP_TYPE.UPDATE_MAX, line: 1, start: L, len: R-L+1, msg: "Update Max" });
            L--; R++;
        }
        if(L >= 0 && R < n) steps.push({ type: STEP_TYPE.MISMATCH, line: 1, i: L, j: R, msg: `Mismatch '${s[L]}' != '${s[R]}'. Stop.` });
    }
    return steps;
}

function generateDP(s) {
    const steps = []; const n = s.length;
    const dp = Array(n).fill().map(()=>Array(n).fill(false));
    steps.push({ type: STEP_TYPE.INIT, line: 0, msg: "Init DP Table" });
    
    // Len 1
    for(let i=0; i<n; i++) {
        dp[i][i] = true;
        steps.push({ type: STEP_TYPE.MATCH, line: 0, i, j: i, dp: true, msg: "Base Case: Length 1" });
        steps.push({ type: STEP_TYPE.UPDATE_MAX, line: 0, start: i, len: 1, msg: "Max found" });
    }
    // Len 2+
    for(let len=2; len<=n; len++) {
        for(let i=0; i<=n-len; i++) {
            let j = i+len-1;
            steps.push({ type: STEP_TYPE.COMPARE, line: 3, i, j, msg: `Checking s[${i}] vs s[${j}]` });
            if(s[i]===s[j]) {
                if(len===2 || dp[i+1][j-1]) {
                    dp[i][j] = true;
                    steps.push({ type: STEP_TYPE.MATCH, line: 4, i, j, dp: true, msg: "Match! Palindrome found." });
                    steps.push({ type: STEP_TYPE.UPDATE_MAX, line: 4, start: i, len, msg: "Update Max" });
                } else {
                    steps.push({ type: STEP_TYPE.MISMATCH, line: 3, i, j, dp: false, msg: "Ends match but inner is not palindrome." });
                }
            } else {
                steps.push({ type: STEP_TYPE.MISMATCH, line: 3, i, j, dp: false, msg: "Mismatch." });
            }
        }
    }
    return steps;
}

// --- UI Builders ---
function buildStringUI(s) {
    els.strContainer.innerHTML = s.split('').map((c,i) => 
        `<div id="char-${i}" class="w-8 h-8 md:w-10 md:h-10 border-2 border-slate-700 rounded flex items-center justify-center text-slate-300 font-bold char-box relative">
            ${c}<span class="absolute -top-4 text-[10px] text-slate-600">${i}</span>
        </div>`
    ).join('');
}
function buildGridUI(n) {
    els.grid.style.gridTemplateColumns = `repeat(${n}, minmax(0, 1fr))`;
    els.grid.innerHTML = '';
    for(let i=0; i<n; i++) {
        for(let j=0; j<n; j++) {
            const c = document.createElement('div');
            c.id = `cell-${i}-${j}`;
            c.className = `cell w-6 h-6 md:w-8 md:h-8 border border-slate-800 bg-slate-800/50 rounded flex items-center justify-center text-[10px] text-slate-500`;
            if(i>j) c.classList.add('opacity-0');
            els.grid.appendChild(c);
        }
    }
}

// --- Playback ---
function togglePlayback() { if(state.isPlaying) stopPlayback(); else startPlayback(); }
function startPlayback() { state.isPlaying = true; els.btnPlay.innerHTML = '<i class="fas fa-pause"></i>'; playLoop(); }
function stopPlayback() { state.isPlaying = false; clearTimeout(state.timer); els.btnPlay.innerHTML = '<i class="fas fa-play pl-1"></i>'; }
function playLoop() { if(state.currentStepIndex < state.steps.length-1) { nextStep(); state.timer = setTimeout(playLoop, state.speed); } else stopPlayback(); }
function nextStep() { if(state.currentStepIndex < state.steps.length-1) { state.currentStepIndex++; applyStep(state.steps[state.currentStepIndex]); updateControls(); } }
function prevStep() { if(state.currentStepIndex > 0) { state.currentStepIndex--; applyStep(state.steps[state.currentStepIndex]); updateControls(); } }
function updateControls() { els.btnPrev.disabled = state.currentStepIndex < 0; els.btnNext.disabled = state.currentStepIndex >= state.steps.length-1; }
function highlightCode(line) {
    document.querySelectorAll('.code-active').forEach(e=>e.classList.remove('code-active'));
    if(line >= 0) document.getElementById(`code-line-${line}`)?.classList.add('code-active');
}

function applyStep(step) {
    els.instruction.textContent = step.msg;
    els.stepExplanation.textContent = step.msg;
    highlightCode(step.line);

    // Reset visual cues
    document.querySelectorAll('.char-active').forEach(e => e.classList.remove('char-active'));
    document.querySelectorAll('.cell-check').forEach(e => e.classList.remove('cell-check'));

    if (step.i !== undefined) {
        // Highlight Chars
        if (state.algo === 'EXPAND' || state.algo === 'BRUTE') {
            // Range highlight
            for(let k=step.i; k<=(step.j || step.i); k++) {
                document.getElementById(`char-${k}`)?.classList.add('char-active');
            }
        } else {
            // Point highlight
            document.getElementById(`char-${step.i}`)?.classList.add('char-active');
            if(step.j !== undefined) document.getElementById(`char-${step.j}`)?.classList.add('char-active');
        }

        // Highlight Cell (DP only)
        if (state.algo === 'DP' && step.j !== undefined) {
            document.getElementById(`cell-${step.i}-${step.j}`)?.classList.add('cell-check');
        }
    }

    // Set DP Values
    if (state.algo === 'DP' && step.dp !== undefined) {
        const cell = document.getElementById(`cell-${step.i}-${step.j}`);
        if(step.dp) { cell.classList.add('cell-true'); cell.textContent = 'T'; }
        else { cell.classList.add('cell-false'); cell.textContent = 'F'; }
    }

    // Update Stats
    if (step.type === STEP_TYPE.UPDATE_MAX) {
        els.longestDisplay.textContent = state.str.substring(step.start, step.start + step.len);
        els.lengthDisplay.textContent = step.len;
        // Permenant highlight logic omitted for brevity in reset, but usually here we'd mark the best found so far
    }
}

</script>
</body>
</html>
