<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kth Largest/Smallest Element</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; }
        .font-mono { font-family: 'Fira Code', monospace; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Visualization Elements */
        .array-item { transition: all 0.3s ease; }
        .item-default { background-color: #1e293b; border-color: #475569; color: #94a3b8; }
        .item-active { background-color: #3b82f6; border-color: #2563eb; color: white; transform: translateY(-4px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5); }
        .item-pivot { background-color: #f59e0b; border-color: #d97706; color: white; } /* Amber */
        .item-heap { background-color: #8b5cf6; border-color: #7c3aed; color: white; } /* Purple */
        .item-sorted { background-color: #10b981; border-color: #059669; color: white; opacity: 0.5; }
        .item-found { background-color: #10b981; border-color: #059669; color: white; transform: scale(1.1); box-shadow: 0 0 20px rgba(16, 185, 129, 0.6); z-index: 10; }
        .item-dim { opacity: 0.2; }

        .code-active { background-color: #312e81; border-left: 2px solid #818cf8; opacity: 1; font-weight: 500; color: #e0e7ff; }
        .panel-btn { @apply p-1.5 text-slate-400 hover:text-white hover:bg-slate-700 rounded transition-colors; }
        
        /* Layout Helpers */
        .resizer-v { width: 4px; cursor: col-resize; background: #1e293b; z-index: 50; }
        .resizer-h { height: 4px; cursor: row-resize; background: #1e293b; z-index: 50; }
        .drag-overlay { position: fixed; inset: 0; z-index: 9999; cursor: inherit; display: none; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Navbar -->
    <header class="bg-slate-900 border-b border-slate-800 h-14 shrink-0 flex items-center justify-between px-4 z-50">
        <div class="flex items-center gap-3">
            <a href="index.html" class="p-1.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-all">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="font-bold text-white text-sm md:text-base flex items-center gap-2">
                <i class="fas fa-sort-numeric-down text-purple-500"></i>
                Kth Element Finder
            </h1>
        </div>
        <button onclick="layoutReset()" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded border border-slate-700 transition-colors">
            <i class="fas fa-columns mr-1"></i> Reset Layout
        </button>
    </header>

    <div id="layout-container" class="flex flex-col md:flex-row flex-1 overflow-hidden relative">
        <div class="drag-overlay" id="dragOverlay"></div>

        <!-- Sidebar -->
        <aside id="panel-sidebar" class="bg-slate-900 flex flex-col border-b md:border-b-0 md:border-r border-slate-800 min-w-[250px] md:w-80 shrink-0 relative" style="height: auto;">
            <div class="h-10 bg-slate-950/50 border-b border-slate-800 flex items-center justify-between px-3 shrink-0">
                <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Configuration</span>
                <button class="panel-btn md:hidden" onclick="togglePanel('sidebar-content')"><i class="fas fa-chevron-up"></i></button>
            </div>

            <div id="sidebar-content" class="flex-1 overflow-y-auto p-4 space-y-6">
                <!-- Inputs -->
                <div class="space-y-3">
                    <label class="text-xs font-medium text-slate-300">Array (Comma separated)</label>
                    <input type="text" id="inputArray" value="3, 2, 1, 5, 6, 4" 
                        class="w-full bg-slate-800 border border-slate-700 text-white px-3 py-2 rounded-md font-mono text-xs focus:border-purple-500 transition-colors">
                    
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="text-xs font-medium text-slate-300">Find K</label>
                            <input type="number" id="inputK" value="2" min="1" class="w-full bg-slate-800 border border-slate-700 text-white px-3 py-2 rounded-md font-mono text-xs focus:border-purple-500">
                        </div>
                        <div class="flex-1">
                            <label class="text-xs font-medium text-slate-300">Type</label>
                            <select id="inputType" class="w-full bg-slate-800 border border-slate-700 text-white px-3 py-2 rounded-md text-xs focus:border-purple-500 cursor-pointer">
                                <option value="LARGEST">Largest</option>
                                <option value="SMALLEST">Smallest</option>
                            </select>
                        </div>
                    </div>

                    <div class="relative">
                        <label class="text-xs font-medium text-slate-300">Algorithm</label>
                        <select id="algoSelect" class="w-full bg-slate-800 border border-slate-700 text-white px-3 py-2 rounded-md text-xs focus:border-purple-500 cursor-pointer mt-1">
                            <option value="SORT">Solution 1: Sorting (O(N log N))</option>
                            <option value="HEAP">Solution 2: Min-Heap (O(N log K))</option>
                            <option value="QUICK">Solution 3: QuickSelect (Avg O(N))</option>
                        </select>
                    </div>
                    
                    <button id="btnReset" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors shadow-lg shadow-purple-500/20">
                        Set & Reset
                    </button>
                </div>

                <!-- Playback -->
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-semibold uppercase text-slate-400 tracking-wider">Playback</span>
                        <span id="speedLabel" class="text-xs text-slate-400 font-mono">1.0x</span>
                    </div>
                    <div class="flex items-center gap-2 justify-center">
                        <button id="btnPrev" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center text-white disabled:opacity-50"><i class="fas fa-step-backward text-xs"></i></button>
                        <button id="btnPlay" class="w-10 h-10 rounded-full bg-purple-500 hover:bg-purple-600 flex items-center justify-center text-white shadow-lg transition-all hover:scale-105"><i class="fas fa-play pl-1 text-sm"></i></button>
                        <button id="btnNext" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center text-white disabled:opacity-50"><i class="fas fa-step-forward text-xs"></i></button>
                    </div>
                    <input type="range" id="speedRange" min="1" max="50" value="10" class="w-full h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-purple-500">
                </div>

                <!-- Legend -->
                <div class="space-y-2">
                    <h3 class="text-xs font-semibold uppercase text-slate-400 tracking-wider">Legend</h3>
                    <div class="grid grid-cols-2 gap-2 text-[10px]">
                        <div class="flex items-center gap-2"><div class="w-3 h-3 bg-blue-500 rounded"></div><span class="text-slate-400">Current</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 bg-amber-500 rounded"></div><span class="text-slate-400">Pivot</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 bg-purple-500 rounded"></div><span class="text-slate-400">Heap</span></div>
                        <div class="flex items-center gap-2"><div class="w-3 h-3 bg-emerald-500 rounded"></div><span class="text-slate-400">Found</span></div>
                    </div>
                </div>
            </div>
        </aside>

        <div id="resizer-v" class="resizer-v hidden md:block" onmousedown="initDrag(event, 'h')"></div>

        <!-- Right Panel -->
        <div class="flex-1 flex flex-col min-w-0 h-full overflow-hidden">
            
            <!-- Visualizer -->
            <div id="panel-viz" class="flex-1 flex flex-col bg-slate-950 relative min-h-[200px] transition-all">
                <div class="h-10 bg-slate-900/80 border-b border-slate-800 flex items-center justify-between px-3 shrink-0 backdrop-blur-sm z-20">
                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Visualization</span>
                    <button class="panel-btn" onclick="toggleMaximize('panel-viz')"><i class="fas fa-expand text-xs"></i></button>
                </div>

                <div class="flex-1 overflow-auto flex flex-col items-center justify-center p-8 relative" id="vizContainer">
                    
                    <!-- Main Array -->
                    <div class="flex flex-col items-center gap-2 mb-12 w-full">
                        <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Main Array</span>
                        <div id="arrayContainer" class="flex flex-wrap justify-center gap-2"></div>
                    </div>

                    <!-- Aux Container (Heap / Sorted) -->
                    <div id="auxContainerWrapper" class="flex flex-col items-center gap-2 opacity-0 transition-opacity duration-300">
                        <span id="auxLabel" class="text-xs font-bold text-slate-500 uppercase tracking-widest">Auxiliary</span>
                        <div id="auxContainer" class="flex flex-wrap justify-center gap-2 p-4 border border-slate-800 rounded-xl bg-slate-900/50"></div>
                    </div>

                    <!-- Overlay -->
                    <div class="absolute bottom-4 left-0 right-0 text-center pointer-events-none">
                        <span id="instructionText" class="bg-slate-900/90 text-slate-200 px-4 py-2 rounded-full text-sm font-medium border border-slate-700 shadow-xl backdrop-blur-sm">
                            Ready.
                        </span>
                    </div>
                </div>
            </div>

            <div id="resizer-h" class="resizer-h hidden md:block" onmousedown="initDrag(event, 'v')"></div>

            <!-- Code & Details -->
            <div id="panel-code" class="h-1/3 min-h-[40px] bg-slate-900 flex flex-col border-t border-slate-800 relative transition-all">
                <div class="h-10 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-3 shrink-0">
                    <div class="flex gap-4">
                        <button id="tab-code" class="text-xs font-semibold text-white border-b-2 border-purple-500 h-10 px-1 transition-colors" onclick="switchTab('code')">Code Trace</button>
                        <button id="tab-desc" class="text-xs font-semibold text-slate-400 hover:text-white border-b-2 border-transparent h-10 px-1 transition-colors" onclick="switchTab('desc')">Description</button>
                        <button id="tab-sol" class="text-xs font-semibold text-slate-400 hover:text-white border-b-2 border-transparent h-10 px-1 transition-colors" onclick="switchTab('sol')">Solution</button>
                    </div>
                    <div class="flex gap-1">
                        <button class="panel-btn" onclick="toggleMaximize('panel-code')"><i class="fas fa-expand text-xs"></i></button>
                        <button class="panel-btn" onclick="toggleMinimize('panel-code')"><i class="fas fa-minus text-xs"></i></button>
                    </div>
                </div>

                <div class="flex-1 overflow-hidden relative">
                    <!-- Tab: Code -->
                    <div id="content-code" class="absolute inset-0 flex flex-col md:flex-row">
                        <div class="w-full md:w-1/2 overflow-auto p-4 bg-slate-950 border-r border-slate-800">
                            <pre class="font-mono text-xs text-slate-400 leading-relaxed whitespace-pre" id="codeDisplay"></pre>
                        </div>
                        <div class="w-full md:w-1/2 p-4 bg-slate-900 overflow-y-auto">
                            <h4 class="text-purple-400 font-bold text-xs uppercase tracking-wider mb-2">Variables</h4>
                            <div class="font-mono text-xs text-slate-400 space-y-1 mb-4" id="varDisplay"></div>
                            <h4 class="text-slate-500 font-bold text-xs uppercase tracking-wider mb-2">Step Info</h4>
                            <div id="stepExplanation" class="text-slate-300 text-sm leading-relaxed"></div>
                        </div>
                    </div>

                    <!-- Tab: Description -->
                    <div id="content-desc" class="absolute inset-0 overflow-auto p-6 hidden bg-slate-900 text-slate-300 text-sm">
                        <h2 class="text-lg font-bold text-white mb-3">Kth Largest/Smallest Element</h2>
                        <p class="leading-relaxed mb-4">
                            Given an integer array <code>nums</code> and an integer <code>k</code>, return the <code>k</code>th largest element in the array.
                        </p>
                        <p class="leading-relaxed mb-4">
                            Note that it is the <code>k</code>th largest element in the sorted order, not the <code>k</code>th distinct element.
                        </p>
                        <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Examples</h3>
                            <ul class="space-y-2 font-mono text-xs">
                                <li>Input: [3,2,1,5,6,4], k = 2<br>Output: 5</li>
                                <li>Input: [3,2,3,1,2,4,5,5,6], k = 4<br>Output: 4</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Tab: Solution -->
                    <div id="content-sol" class="absolute inset-0 overflow-auto p-6 hidden bg-slate-900 text-slate-300 text-sm">
                        <h2 class="text-lg font-bold text-white mb-2" id="sol-title">Approach</h2>
                        <div id="sol-strategy" class="leading-relaxed mb-4"></div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div class="text-xs font-bold text-slate-500">Time</div>
                                <div id="sol-time" class="text-purple-400 font-mono"></div>
                            </div>
                            <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                                <div class="text-xs font-bold text-slate-500">Space</div>
                                <div id="sol-space" class="text-purple-400 font-mono"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
/** Layout Engine */
let isDragging = false;
let currentResizer = null;
const elsLayout = {
    container: document.getElementById('layout-container'),
    sidebar: document.getElementById('panel-sidebar'),
    vizPanel: document.getElementById('panel-viz'),
    codePanel: document.getElementById('panel-code'),
    dragOverlay: document.getElementById('dragOverlay')
};

function initDrag(e, dir) {
    if(window.innerWidth < 768) return;
    isDragging = true; currentResizer = dir;
    elsLayout.dragOverlay.style.display = 'block';
    document.body.style.cursor = dir === 'h' ? 'col-resize' : 'row-resize';
}

document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    if (currentResizer === 'h') {
        const newWidth = Math.max(200, Math.min(e.clientX, window.innerWidth * 0.5));
        elsLayout.sidebar.style.width = `${newWidth}px`;
        elsLayout.sidebar.style.flex = 'none';
    } else {
        const rect = elsLayout.container.getBoundingClientRect();
        const newCodeHeight = rect.height - (e.clientY - rect.top);
        const h = Math.max(40, Math.min(newCodeHeight, rect.height * 0.8));
        elsLayout.codePanel.style.height = `${h}px`;
    }
});

document.addEventListener('mouseup', () => {
    if(isDragging) { isDragging = false; elsLayout.dragOverlay.style.display = 'none'; document.body.style.cursor = ''; }
});

function toggleMaximize(id) {
    if(id === 'panel-viz') elsLayout.codePanel.style.height = elsLayout.codePanel.style.height === '40px' ? '33%' : '40px';
    else elsLayout.codePanel.style.height = elsLayout.codePanel.style.height === '80%' ? '33%' : '80%';
}
function toggleMinimize(id) { document.getElementById(id).style.height = '40px'; }
function layoutReset() { if(window.innerWidth >= 768) { elsLayout.sidebar.style.width = '20rem'; elsLayout.codePanel.style.height = '33%'; } }
function togglePanel(id) {
    const el = document.getElementById(id);
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

/** Logic */
const state = { arr: [], k: 0, type: 'LARGEST', algo: 'SORT', steps: [], currentStepIndex: -1, isPlaying: false, speed: 500, timer: null };

const els = {
    inputArr: document.getElementById('inputArray'), inputK: document.getElementById('inputK'), inputType: document.getElementById('inputType'),
    algoSelect: document.getElementById('algoSelect'), btnReset: document.getElementById('btnReset'),
    btnPrev: document.getElementById('btnPrev'), btnPlay: document.getElementById('btnPlay'), btnNext: document.getElementById('btnNext'),
    speedRange: document.getElementById('speedRange'), speedLabel: document.getElementById('speedLabel'),
    arrayContainer: document.getElementById('arrayContainer'), auxContainer: document.getElementById('auxContainer'),
    auxWrapper: document.getElementById('auxContainerWrapper'), auxLabel: document.getElementById('auxLabel'),
    instruction: document.getElementById('instructionText'), varDisplay: document.getElementById('varDisplay'),
    codeDisplay: document.getElementById('codeDisplay'), stepExplanation: document.getElementById('stepExplanation'),
    solTitle: document.getElementById('sol-title'), solStrategy: document.getElementById('sol-strategy'), solTime: document.getElementById('sol-time'), solSpace: document.getElementById('sol-space')
};

const ALGOS = {
    SORT: {
        name: "Sorting",
        desc: "Sorts the entire array and picks the Kth element.",
        strategy: "1. Sort the array in descending (for largest) or ascending (for smallest) order.\n2. Return the element at index K-1.",
        time: "O(N log N)", space: "O(1) or O(N)",
        code: [
            { text: "func solve(arr, k):", indent: 0 },
            { text: "arr.sort()", indent: 1 },
            { text: "return arr[k-1]", indent: 1 }
        ]
    },
    HEAP: {
        name: "Min-Heap",
        desc: "Maintains a heap of size K to find the Kth largest element efficiently.",
        strategy: "For Kth Largest: Use a Min-Heap of size K. Iterate through the array. If element > heap.peek(), pop and push. Finally, heap root is Kth largest.\nFor Kth Smallest: Use Max-Heap of size K.",
        time: "O(N log K)", space: "O(K)",
        code: [
            { text: "heap = MinHeap(size=k)", indent: 0 },
            { text: "for num in arr:", indent: 0 },
            { text: "heap.push(num)", indent: 1 },
            { text: "if heap.size > k:", indent: 1 },
            { text: "heap.pop()", indent: 2 },
            { text: "return heap.peek()", indent: 0 }
        ]
    },
    QUICK: {
        name: "QuickSelect",
        desc: "Uses partitioning logic (like QuickSort) to find position without full sort.",
        strategy: "Pick a pivot. Partition array into < pivot and > pivot. If pivot index == k, return pivot. Else recurse on left or right subarray. Average case O(N).",
        time: "Avg O(N), Worst O(NÂ²)", space: "O(1)",
        code: [
            { text: "func select(left, right, k):", indent: 0 },
            { text: "pivot = partition(left, right)", indent: 1 },
            { text: "if pivot == k: return arr[k]", indent: 1 },
            { text: "elif pivot < k: select(pivot+1, right, k)", indent: 1 },
            { text: "else: select(left, pivot-1, k)", indent: 1 }
        ]
    }
};

const STEP_TYPE = { INIT: 'INIT', ACTIVE: 'ACTIVE', SWAP: 'SWAP', HEAP_PUSH: 'HEAP_PUSH', HEAP_POP: 'HEAP_POP', PIVOT: 'PIVOT', FOUND: 'FOUND', PARTITION: 'PARTITION' };

init();

function init() {
    setupEventListeners();
    resetVisualization();
    layoutReset();
}

function switchTab(t) {
    ['code','desc','sol'].forEach(x => {
        const isSelected = (x === t);
        const tabBtn = document.getElementById(`tab-${x}`);
        const contentDiv = document.getElementById(`content-${x}`);
        
        // Toggle Tab Styles
        tabBtn.classList.toggle('text-white', isSelected);
        tabBtn.classList.toggle('border-purple-500', isSelected);
        tabBtn.classList.toggle('text-slate-400', !isSelected);
        tabBtn.classList.toggle('border-transparent', !isSelected);
        
        // Toggle Content Visibility
        if (isSelected) {
            contentDiv.classList.remove('hidden');
            // 'code' needs flex, others block
            contentDiv.style.display = (x === 'code') ? 'flex' : 'block';
        } else {
            contentDiv.classList.add('hidden');
            contentDiv.style.display = 'none';
        }
    });
}

function setupEventListeners() {
    els.btnReset.addEventListener('click', resetVisualization);
    els.algoSelect.addEventListener('change', resetVisualization);
    els.inputType.addEventListener('change', resetVisualization);
    els.btnNext.addEventListener('click', () => { stopPlayback(); nextStep(); });
    els.btnPrev.addEventListener('click', () => { stopPlayback(); prevStep(); });
    els.btnPlay.addEventListener('click', togglePlayback);
    els.speedRange.addEventListener('input', (e) => {
        state.speed = Math.max(50, 1500 - (e.target.value * 28));
        els.speedLabel.textContent = `${(1000/state.speed).toFixed(1)}x`;
        if(state.isPlaying) { stopPlayback(); startPlayback(); }
    });
}

function resetVisualization() {
    stopPlayback();
    // Parse Input
    const raw = els.inputArr.value.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
    state.arr = raw.length > 0 ? raw : [3, 2, 1, 5, 6, 4];
    state.k = parseInt(els.inputK.value) || 2;
    state.type = els.inputType.value;
    state.algo = els.algoSelect.value;
    
    // Bounds check
    if(state.k > state.arr.length) state.k = state.arr.length;
    if(state.k < 1) state.k = 1;
    els.inputK.value = state.k;

    // Render Info
    const info = ALGOS[state.algo];
    els.codeDisplay.innerHTML = info.code.map((l,i) => `<div id="code-line-${i}" class="code-line">${'&nbsp;'.repeat(l.indent*2)}${l.text}</div>`).join('');
    els.solTitle.textContent = info.name + (state.type==='LARGEST' ? " (Kth Largest)" : " (Kth Smallest)");
    els.solStrategy.textContent = info.strategy;
    els.solTime.textContent = info.time;
    els.solSpace.textContent = info.space;

    // UI Reset
    buildArrayUI(state.arr);
    els.auxWrapper.style.opacity = '0';
    els.auxContainer.innerHTML = '';

    // Generate Steps
    if (state.algo === 'SORT') state.steps = generateSortSteps([...state.arr]);
    else if (state.algo === 'HEAP') state.steps = generateHeapSteps([...state.arr]);
    else state.steps = generateQuickSteps([...state.arr]);

    state.currentStepIndex = -1;
    els.instruction.textContent = "Ready.";
    highlightCode(-1);
    updateControls();
}

// --- Generators ---

function generateSortSteps(arr) {
    const steps = [];
    steps.push({ type: STEP_TYPE.INIT, arr: [...arr], msg: "Start Sorting..." });
    
    // Bubble sort visualization for simplicity
    const n = arr.length;
    for (let i = 0; i < n - 1; i++) {
        for (let j = 0; j < n - i - 1; j++) {
            // Determine comparison based on Largest/Smallest
            // To find Kth Largest: Sort Descending. Kth Smallest: Sort Ascending.
            const condition = state.type === 'LARGEST' ? arr[j] < arr[j+1] : arr[j] > arr[j+1];
            steps.push({ type: STEP_TYPE.ACTIVE, arr: [...arr], indices: [j, j+1], line: 1, msg: `Comparing ${arr[j]} and ${arr[j+1]}` });
            
            if (condition) {
                [arr[j], arr[j+1]] = [arr[j+1], arr[j]];
                steps.push({ type: STEP_TYPE.SWAP, arr: [...arr], indices: [j, j+1], line: 1, msg: "Swapping" });
            }
        }
    }
    
    steps.push({ type: STEP_TYPE.FOUND, arr: [...arr], indices: [state.k - 1], line: 2, msg: `Sorted. Element at index ${state.k-1} is result: ${arr[state.k-1]}` });
    return steps;
}

function generateHeapSteps(arr) {
    const steps = [];
    const heap = [];
    const k = state.k;
    // Kth Largest -> Min Heap. Kth Smallest -> Max Heap.
    const isMinHeap = state.type === 'LARGEST';
    
    steps.push({ type: STEP_TYPE.INIT, arr: [...arr], heap: [], msg: `Init ${isMinHeap?'Min':'Max'} Heap of size ${k}` });

    for(let i=0; i<arr.length; i++) {
        const val = arr[i];
        steps.push({ type: STEP_TYPE.ACTIVE, arr: [...arr], indices: [i], heap: [...heap], line: 1, msg: `Processing ${val}` });
        
        // Push
        heap.push(val);
        // Sort heap for visualization (fake heap structure)
        if(isMinHeap) heap.sort((a,b)=>a-b); else heap.sort((a,b)=>b-a);
        
        steps.push({ type: STEP_TYPE.HEAP_PUSH, arr: [...arr], indices: [i], heap: [...heap], line: 2, msg: `Push ${val} to heap` });

        if (heap.length > k) {
            const removed = heap.shift(); // Remove root (min or max)
            steps.push({ type: STEP_TYPE.HEAP_POP, arr: [...arr], indices: [i], heap: [...heap], line: 4, msg: `Heap > K. Removed ${removed}` });
        }
    }
    
    steps.push({ type: STEP_TYPE.FOUND, arr: [...arr], heap: [...heap], indices: [], line: 5, msg: `Result is Heap Root: ${heap[0]}`, val: heap[0] });
    return steps;
}

function generateQuickSteps(arr) {
    const steps = [];
    const targetK = state.type === 'SMALLEST' ? state.k - 1 : arr.length - state.k;
    
    function partition(low, high) {
        const pivot = arr[high];
        steps.push({ type: STEP_TYPE.PIVOT, arr: [...arr], indices: [high], line: 1, msg: `Pivot chosen: ${pivot}`, range: [low, high] });
        let i = low;
        
        for (let j = low; j < high; j++) {
            steps.push({ type: STEP_TYPE.ACTIVE, arr: [...arr], indices: [j], pivotIdx: high, line: 1, msg: `Checking ${arr[j]}`, range: [low, high] });
            if (arr[j] < pivot) {
                [arr[i], arr[j]] = [arr[j], arr[i]];
                steps.push({ type: STEP_TYPE.SWAP, arr: [...arr], indices: [i, j], pivotIdx: high, line: 1, msg: `Swapping ${arr[i]} <-> ${arr[j]}`, range: [low, high] });
                i++;
            }
        }
        [arr[i], arr[high]] = [arr[high], arr[i]];
        steps.push({ type: STEP_TYPE.PARTITION, arr: [...arr], indices: [i, high], line: 1, msg: `Place pivot at ${i}`, range: [low, high] });
        return i;
    }

    function quickSelect(low, high) {
        if (low <= high) {
            const pi = partition(low, high);
            if (pi === targetK) {
                steps.push({ type: STEP_TYPE.FOUND, arr: [...arr], indices: [pi], line: 2, msg: `Pivot index ${pi} matches target! Found: ${arr[pi]}` });
                return;
            } else if (pi < targetK) {
                steps.push({ type: STEP_TYPE.INIT, arr: [...arr], line: 3, msg: `${pi} < target. Recurse Right`, range: [pi+1, high] });
                quickSelect(pi + 1, high);
            } else {
                steps.push({ type: STEP_TYPE.INIT, arr: [...arr], line: 4, msg: `${pi} > target. Recurse Left`, range: [low, pi-1] });
                quickSelect(low, pi - 1);
            }
        }
    }

    quickSelect(0, arr.length - 1);
    return steps;
}

// --- UI Builders ---

function buildArrayUI(arr) {
    els.arrayContainer.innerHTML = arr.map((val, idx) => 
        `<div id="idx-${idx}" class="array-item w-10 h-10 md:w-12 md:h-12 border-2 border-slate-600 rounded-lg flex items-center justify-center text-slate-200 font-bold text-sm md:text-lg relative item-default">
            ${val}
            <span class="absolute -bottom-5 text-[10px] text-slate-600 font-mono">${idx}</span>
        </div>`
    ).join('');
}

function updateHeapUI(heap) {
    els.auxWrapper.style.opacity = '1';
    els.auxLabel.textContent = `Heap (Size ${heap.length})`;
    els.auxContainer.innerHTML = heap.map(val => 
        `<div class="w-8 h-8 md:w-10 md:h-10 border-2 border-purple-500 bg-purple-900/50 rounded-full flex items-center justify-center text-white font-bold text-xs md:text-sm shadow-md">
            ${val}
        </div>`
    ).join('');
}

// --- Playback Logic ---
function togglePlayback() { if(state.isPlaying) stopPlayback(); else startPlayback(); }
function startPlayback() { state.isPlaying = true; els.btnPlay.innerHTML = '<i class="fas fa-pause"></i>'; playLoop(); }
function stopPlayback() { state.isPlaying = false; clearTimeout(state.timer); els.btnPlay.innerHTML = '<i class="fas fa-play pl-1"></i>'; }
function playLoop() { if(state.currentStepIndex < state.steps.length-1) { nextStep(); state.timer = setTimeout(playLoop, state.speed); } else stopPlayback(); }
function nextStep() { if(state.currentStepIndex < state.steps.length-1) { state.currentStepIndex++; applyStep(state.steps[state.currentStepIndex]); updateControls(); } }
function prevStep() { if(state.currentStepIndex > 0) { state.currentStepIndex--; applyStep(state.steps[state.currentStepIndex]); updateControls(); } }
function updateControls() { els.btnPrev.disabled = state.currentStepIndex < 0; els.btnNext.disabled = state.currentStepIndex >= state.steps.length-1; }
function highlightCode(line) { document.querySelectorAll('.code-active').forEach(e=>e.classList.remove('code-active')); if(line >= 0) document.getElementById(`code-line-${line}`)?.classList.add('code-active'); }

function applyStep(step) {
    els.instruction.textContent = step.msg;
    els.stepExplanation.textContent = step.msg;
    highlightCode(step.line);
    
    // Update Array UI
    if(step.arr) {
        step.arr.forEach((val, idx) => {
            const el = document.getElementById(`idx-${idx}`);
            if(el) {
                el.textContent = val;
                el.className = 'array-item w-10 h-10 md:w-12 md:h-12 border-2 border-slate-600 rounded-lg flex items-center justify-center text-slate-200 font-bold text-sm md:text-lg relative item-default';
                
                // Dim items outside range (QuickSelect)
                if (step.range && (idx < step.range[0] || idx > step.range[1])) {
                    el.classList.add('item-dim');
                }
            }
        });
    }

    // Highlighting
    if (step.indices) {
        step.indices.forEach(i => {
            const el = document.getElementById(`idx-${i}`);
            if(!el) return;
            if (step.type === STEP_TYPE.FOUND) el.className += ' item-found';
            else if (step.type === STEP_TYPE.PIVOT) el.className += ' item-pivot';
            else el.className += ' item-active';
        });
    }
    
    if (step.pivotIdx !== undefined) {
        document.getElementById(`idx-${step.pivotIdx}`)?.classList.add('item-pivot');
    }

    // Heap UI
    if (step.heap) {
        updateHeapUI(step.heap);
    } else if (state.algo !== 'HEAP') {
        els.auxWrapper.style.opacity = '0';
    }
    
    // Var Display
    let vars = ``;
    if(state.algo === 'QUICK' && step.range) vars += `Range: [${step.range[0]}, ${step.range[1]}] `;
    els.varDisplay.textContent = vars;
}

</script>
</body>
</html>
